<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MyBusTimes Multi-Route Duty Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial, Helvetica, sans-serif;
    background: #e6e6e6;
    margin: 0;
}

header {
    background: #000;
    color: #fff;
    padding: 12px;
    text-align: center;
    font-size: 20px;
}

.panel, .duty {
    background: #fff;
    max-width: 480px;
    margin: 15px auto;
    padding: 12px;
    border-radius: 6px;
}

input, select {
    width: 100%;
    padding: 8px;
    margin-bottom: 6px;
    font-size: 14px;
}

button {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    background: #000;
    color: #fff;
    border: none;
    cursor: pointer;
}

.add { background:#444; }
.warn { color:red; font-weight:bold; }

.trip-row {
    display: grid;
    grid-template-columns: 55px auto auto 50px 25px;
    gap: 5px;
    padding: 6px 0;
    font-size: 13px;
    cursor: grab;
    align-items: center;
}

.trip-row span { font-weight:bold; }

.trip-row button {
    background:none;
    color:red;
    padding:0;
    margin:0;
}

.trip-row input {
    font-size:13px;
    padding:2px;
    width:100%;
}

.duty-header {
    border-bottom:1px solid #ccc;
    padding-bottom:6px;
}

.route { font-size:28px; font-weight:bold; }
.depot { font-size:13px; color:#555; }

.trip {
    display:grid;
    grid-template-columns:55px auto;
    padding:6px 0;
    border-bottom:1px solid #eee;
}

.footer {
    font-size:12px;
    background:#f5f5f5;
    padding:6px;
}

@media print {
    body { background:white; }
    header, .panel { display:none; }
    .duty { border:none; }
}
</style>
</head>

<body>

<header>MyBusTimes Multi-Route Duty Generator</header>

<div class="panel">
    <input id="route" placeholder="Route (e.g. X1)">
    <input id="depot" placeholder="Depot (e.g. Wick)">

    <hr>

    <input id="time" placeholder="Time (HH:MM)">
    <input id="from" placeholder="From">
    <input id="to" placeholder="To">
    <select id="type">
        <option value="trip">Trip</option>
        <option value="break">Break</option>
    </select>

    <button class="add" onclick="addItem()">Add to duty</button>

    <div id="editor"></div>

    <button onclick="generateDuty()">Generate duty</button>
    <button onclick="saveDuty()">Save duty</button>
    <button onclick="loadDuty()">Load duty</button>
    <button onclick="addRoute()">Add new route</button>
</div>

<div id="output"></div>

<script>
let dutyRoutes = [];
let currentRoute = {route:'', depot:'', items:[]};
let dragIndex = null;

// Convert HH:MM to minutes
function toMin(t){
    const [h,m]=t.split(":").map(Number);
    return h*60+m;
}

// Add trip or break
function addItem(){
    const routeEl = document.getElementById("route");
    const depotEl = document.getElementById("depot");
    const time = document.getElementById("time").value.trim();
    const from = document.getElementById("from").value.trim();
    const to = document.getElementById("to").value.trim();
    const type = document.getElementById("type").value;

    if(!routeEl.value || !depotEl.value) return alert("Enter route & depot");
    if(type==='trip' && (!time || !from || !to)) return alert("Fill all trip fields");

    currentRoute.route = routeEl.value;
    currentRoute.depot = depotEl.value;

    let item = type==='trip' ? {time, from, to, type} : {time, type};
    currentRoute.items.push(item);

    // Clear inputs
    document.getElementById("time").value = "";
    document.getElementById("from").value = "";
    document.getElementById("to").value = "";

    renderEditor();
}

// Render editor with inline edit/delete & drag
function renderEditor(){
    const editor = document.getElementById("editor");
    editor.innerHTML = "";
    currentRoute.items.forEach((t,i)=>{
        const d = document.createElement("div");
        d.className="trip-row";
        d.draggable = true;
        d.ondragstart = () => dragIndex=i;
        d.ondragover = e => e.preventDefault();
        d.ondrop = () => swap(i);

        if(t.type==='trip'){
            d.innerHTML=`
                <span>${t.time}</span>
                <input value="${t.from}" onchange="currentRoute.items[${i}].from=this.value">
                <input value="${t.to}" onchange="currentRoute.items[${i}].to=this.value">
                <span>Trip</span>
                <button onclick="del(${i})">✖</button>
            `;
        } else {
            d.innerHTML=`
                <span>${t.time}</span>
                <div>Break</div>
                <span>Break</span>
                <button onclick="del(${i})">✖</button>
            `;
        }
        editor.appendChild(d);
    });
}

// Swap items
function swap(i){
    [currentRoute.items[dragIndex], currentRoute.items[i]] = [currentRoute.items[i], currentRoute.items[dragIndex]];
    renderEditor();
}

// Delete item
function del(i){
    currentRoute.items.splice(i,1);
    renderEditor();
}

// Add route to dutyRoutes array
function addRoute(){
    if(!currentRoute.route || !currentRoute.depot || !currentRoute.items.length) return alert("Complete current route first");
    dutyRoutes.push(JSON.parse(JSON.stringify(currentRoute)));
    currentRoute = {route:'', depot:'', items:[]};
    document.getElementById("route").value='';
    document.getElementById("depot").value='';
    document.getElementById("editor").innerHTML='';
    alert("Route added. You can start new route.");
}

// Generate duty card
function generateDuty(){
    let html='';
    let dutyRoutesCopy = JSON.parse(JSON.stringify(dutyRoutes));

    if(currentRoute.items.length>0){
        dutyRoutesCopy.push(JSON.parse(JSON.stringify(currentRoute)));
    }

    if(dutyRoutesCopy.length===0) return alert("Add at least one route");

    dutyRoutesCopy.forEach(r=>{
        let items = r.items.slice().sort((a,b)=>a.time && b.time ? toMin(a.time)-toMin(b.time) : 0);
        let total=0;
        for(let i=1;i<items.length;i++){
            if(items[i].type==='trip' && items[i-1].type==='trip')
                total+=toMin(items[i].time)-toMin(items[i-1].time);
        }
        let breakWarn = total>270;
        let finish='';
        for(let i=items.length-1;i>=0;i--){
            if(items[i].type==='trip'){ finish=items[i].to; break; }
        }
        let badFinish = finish !== r.depot;

        html += `<div class="duty">
            <div class="duty-header">
                <div class="route">${r.route}</div>
                <div class="depot">${r.depot} Depot</div>
            </div>`;

        items.forEach(t=>{
            if(t.type==='trip'){
                html+=`
                <div class="trip">
                    <div><strong>${t.time}</strong></div>
                    <div>${t.from} → ${t.to}</div>
                </div>`;
            } else {
                html+=`
                <div class="trip">
                    <div><strong>${t.time}</strong></div>
                    <div><em>Break</em></div>
                </div>`;
            }
        });

        html+=`
            <div class="footer">
                Total duty: ${total} mins<br>
                ${breakWarn?'<span class="warn">Break required</span><br>':``}
                Finish: ${finish}${badFinish?' ⚠':''}
            </div>
        </div>`;
    });

    document.getElementById("output").innerHTML = html;
}

// Save/load all routes
function saveDuty(){
    localStorage.setItem("multiDuty", JSON.stringify({dutyRoutes, currentRoute}));
    alert("Duty saved");
}

function loadDuty(){
    const d = JSON.parse(localStorage.getItem("multiDuty"));
    if(!d) return;
    dutyRoutes = d.dutyRoutes;
    currentRoute = d.currentRoute;
    document.getElementById("route").value=currentRoute.route;
    document.getElementById("depot").value=currentRoute.depot;
    renderEditor();
}
</script>

</body>
</html>
